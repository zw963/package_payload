#!/bin/sh

dir=$(mktemp -d)
mkdir -p $dir/local/bin

recovery_1=$dir/local/bin/recovery.sh

cat <<'HEREDOC' > $recovery_1
#!/bin/sh
export EDITOR="dte"
# alias apti='apt-get install -qq -y --no-install-recommends'
alias nano=dte
/bin/sh
HEREDOC

chmod +x $recovery_1

ROOT=${0%/*}

# container_names=$(docker ps |grep -v -e 'ago\s*Restarting'|rev |cut -d' ' -f1 |rev |tail -n +2)
container_names=$(docker ps --format '{{.Names}} {{.ID}}')
# images_names=$(docker ps -a |awk '{print $2}' |tail -n +2)
images_names=$(docker images --format '{{.Repository}} {{.ID}}')
all_container_names=$(docker ps -a --format '{{.Names}} {{.ID}}')
volumes=$(docker volume ls |awk '{print $2}'|tail -n +2)

# è®¾å®š args
[ "$DOCKERIZED_APP_NETWORK" ] && args="--network=$DOCKERIZED_APP_NETWORK"

[ -e .env ] && env_arg='--env-file .env'

function is_port_exist () {
    netstat -tunl |grep -F 'LISTEN' |awk '{print $4}' |grep ':'"$*"'$'
}

if [ "$*" ]; then
    image_name=$(echo "$1" |cut -d':' -f1)
    if echo "$container_names" |grep -F -qs -- "$image_name"; then
        # è¡¨ç¤º container å­˜åœ¨, å¹¶ä¸”å·²ç»å¯åŠ¨äº†, åˆ™ç›´æ¥ attach è¿›å».
        docker cp $ROOT/dte "$1":/usr/local/bin/
        docker exec -it --privileged "$@" /bin/sh
    elif echo "$images_names" |grep -F -qs -- "$image_name"; then
        # å¦‚æœæ˜¯ä¸€ä¸ª images, åˆ™ç›´æ¥å¯åŠ¨ä¸€ä¸ªä¸´æ—¶çš„ container.
        # è‡ªåŠ¨æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¯ç”¨çš„ç«¯å£.
        init_port=3000
        while is_port_exist "$init_port"; do
            init_port=$(($init_port+1))
        done

        next_port=$(($init_port+1))
        while is_port_exist "$next_port"; do
            next_port=$(($next_port+1))
        done

        echo "[0m[32mport: $init_port:3000, $next_port:80[0m"

        docker run -it $env_arg \
               -e TERM=$TERM \
               -v $ROOT/dte:/usr/local/bin/dte \
               -v $recovery_1:/recovery_1.sh \
               --entrypoint /recovery_1.sh \
               --ulimit nofile=150000:150000 \
               -p $init_port:3000 \
               -p $next_port:80 \
               --rm --privileged  $args "$@" /bin/sh
    elif echo "$all_container_names" |grep -F -qs -- "$1"; then
        # å¦‚æœ container å­˜åœ¨, ä½†æ˜¯å¤„äºé€€å‡ºçŠ¶æ€, ä¸€èˆ¬éƒ½æ˜¯ build å¤±è´¥äº†.
        # æ­¤æ—¶, è¿›å…¥è¿™ä¸ª container, æŸ¥è¯¢å¤±è´¥çš„åŸå› æœ‰æ—¶å€™æ˜¯æœ‰å¿…è¦çš„ã€‚

        # å°†å½“å‰å¤±è´¥çš„çŠ¶æ€ï¼Œæäº¤åˆ°ä¸€ä¸ªä¸´æ—¶çš„ image, å¹¶è®°å½•è¿™ä¸ª image çš„å“ˆå¸Œ.
        tmp_images_hash=$(docker commit "$1"|cut -d: -f2|cut -c1-12)
        # è·å–è¿™ä¸ªå¤±è´¥çš„ container åŠ å…¥çš„æœ€åä¸€ä¸ª network

        # è¿™ä¸ªç½‘ç»œå¤±è´¥äº†ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œå…ˆæ³¨é‡Šæ‰ã€‚
        # network=$(docker inspect -f '{{json .NetworkSettings.Networks}}' "$1" |egrep -o '"[a-z-]+\.network"' |tail -n1|cut -d'"' -f2)
        # echo "Connect to network ${network} ..."

        # --network=$network \

        docker run -it $env_arg \
               -e TERM=$TERM \
               -v $ROOT/dte:/usr/local/bin/dte \
               -v $recovery_1:/recovery_1.sh \
               --entrypoint /recovery_1.sh \
               --rm --privileged \
               $args $tmp_images_hash
        docker rmi -f $tmp_images_hash
    elif echo "$volumes" | grep -F -qs -- "$1"; then
        docker run -it $env_arg \
               -e TERM=$TERM \
               -v $ROOT/dte:/usr/local/bin/dte \
               -v $recovery_1:/recovery_1.sh \
               --entrypoint /recovery_1.sh \
               -v "$1":/data \
               --rm --privileged $args \
               alpine /bin/bash
    else
        echo "error, not exist $1"
    fi
else
    case $(basename $0) in
        docker_bash)
            last_container=$(docker ps -q |head -n1)
            ;;
        docker_bash!)
            last_container=$(docker ps -aq |head -n1)
    esac

    if [ "$last_container" ]; then
        docker cp $dir/local "$last_container":/usr/
        docker exec -it --privileged $last_container /bin/sh
    else
        echo "error, not exist container"
    fi
fi
